<!DOCTYPE html>

<head>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>Saling Sulam</title>
  <!-- include CSS -->
  <link href="index.css" rel="stylesheet" type="text/css" />
  <!-- include three.js library -->
  <script src='libs/three.min.js'></script>
  <!-- include jsartookit -->
  <script src="jsartoolkit5/artoolkit.min.js"></script>
  <script src="jsartoolkit5/artoolkit.api.js"></script>
  <!-- include threex.artoolkit -->
  <script src="threex/threex-artoolkitsource.js"></script>
  <script src="threex/threex-artoolkitcontext.js"></script>
  <script src="threex/threex-arbasecontrols.js"></script>
  <script src="threex/threex-armarkercontrols.js"></script>
  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- include other scripts -->
  <script src="libs/inflate.min.js"></script>
  <script src="libs/FBXLoader.js"></script>
  <script src="libs/OrbitControls.js"></script>
  <script src="libs/Detector.js"></script>
  <script src="libs/joy.js"></script>
  <!-- <script src="libs/toon3d.js"></script> -->
  <script src="libs/jquery-3.6.0.min.js"></script>
</head>

<body style='margin : 0px; overflow: hidden; '>

  <!-- 
  Example created by Lee Stemkoski: https://github.com/stemkoski
  Based on the AR.js library and examples created by Jerome Etienne: https://github.com/jeromeetienne/AR.js/
-->

  <button onclick="openModal()" style="background-color: rgb(244, 241, 235, .7); height:70px; width:70px;border-radius: 4px;bottom:calc( 5% + 15px);left:5%; position:absolute;z-index: 10;">

    <img id="selectedMotif" src="assets/brush/Beads-1.png"
    style="height:60%;width:100%;" />
    <div style="color:black; font-size: 12px; font-weight: 500;">
      Pilih Pola
    </div>
  </button>

  <div id="joyDiv" onmousedown="joystickStart()" ontouchstart="joystickStart()"
    style="width:100px;height:100px;bottom:5%;left:50%;margin-left:-50px;position:absolute;z-index: 10;"></div>

    <button onMouseOver="this.style.background='#E67C3A'" onMouseOut="this.style.background='#F68C4A'" onclick="actionAdd()" style="background-color: #F68C4A; height:80px; width:80px; border-radius: 50%;bottom:calc( 5% + 10px);right:5%; position:absolute;z-index: 10;">
      <div style="font-weight: 900; color: white; font-family: 'Handlee', cursive; font-size: 20px;user-select: none;">
        Sulam!
      </div>
    </button>

  <div id="container">
    <div id="home">
      <img src="assets/brush/Beads-6.png"
        style="height:40vh;width:40vh; position: absolute; top:0;left:0; transform:translate(-10vh,-10vh)" />
      <img src="assets/brush/Beads-4.png"
        style="height:30vh;width:30vh; position: absolute; top:0;right:0; transform:translate(10vh,3vh)" />
      <div class="formContainer">
        <h1>
          Saling Sulam
        </h1>
        <h2>
          Silakan masukkan nama kamu.
        </h2>

        <form class="nameForm" action="">
          <input id="username" />
          <button class="mainButton">
            <h3>
              Masuk
            </h3>
          </button>
        </form>


        <h3>
          Terdapat <span id="onlineUser"></span> pengguna aktif.
        </h3>
      </div>

    </div>
    <div id="modal">
      <div style="height: 200px; width: 200px; border-radius: 50%; display: flex; justify-content: center; align-items: center; background-color: #D9D9D9;">
      
        <img id="motifPreview" src="assets/brush/Beads-9.png"
        style="height:60%;width:100%;" /></div>
        <h2 style="font-size: 18px; margin-bottom:0">
          Pilih motif yang kamu mau.
        </h2>
        <div style=" width: 256px; display: flex; flex-wrap: wrap; ">
          <button id="1" onclick="selectButton(1)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-1.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="2" onclick="selectButton(2)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-2.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="3" onclick="selectButton(3)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-3.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="4" onclick="selectButton(4)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-4.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="5" onclick="selectButton(5)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-5.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="6" onclick="selectButton(6)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-6.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="7" onclick="selectButton(7)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-7.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="8" onclick="selectButton(8)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-8.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="9" onclick="selectButton(9)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-9.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="10" onclick="selectButton(10)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">

            <img src="assets/brush/Beads-10.png"
            style="height:60%;width:100%;" />
          </button>
          <button id="11"  onclick="selectButton(11)" style="background-color: rgb(244, 241, 235, .7); height:60px; width:60px; margin: 2px; border-radius: 4px;">
            <img src="assets/brush/Beads-11.png"
            style="height:60%;width:100%;" />
          </button>
        </div>
        <div>
          <h2 style="font-size: 18px; line-height: 18px; margin-bottom:0">
            Pilih ukuran.
          </h2>
          <input id="sizeSlider" type="range"name="size" min="0" max="100" value="50" step="10" on />
        </div>
        <div style="margin-top: 8px;">
          <button style="background: #a9a9a9; width: 90px; font-size: 14px; font-weight: 700; padding: 8px 16px;" onclick="closeModal()">
            Batal
          </button>
          <button style="font-size: 14px;  width: 90px; font-weight: 700; padding: 8px 16px;" onclick="saveModal()">
            Simpan
          </button>
        </div>
      </div>
    </div>
  </div>
    <script>
      const socket = io();
      // let online;
      let username, id

      let userList = []
      let characterList = []
      let remoteData
      let brushes =[]

      
      // $('#home').hide()

      $(function () {
        $('form').submit((e) => {
          e.preventDefault();//prevents page reloading
          socket.emit("requestJoin", $('#username').val());
          return null;
        });

        socket.on('online', function (data) {
          $('#onlineUser').text(data)
        })
        
        // socket.on('buildingState', function (data) {
        //   console.log(data)
        // })

        socket.on('acceptJoin', function (data) {
          username = data.username;
          id = data.id;
          $('#home').hide()
          initSocket()
        })

        socket.on('remoteData', function (data) {
          remoteData = data;
        });

        socket.on('brushesState', function (data) {
          brushes = data
          
          loadCanvas()
          console.log(brushes)
        })

        socket.on('resetCanvas', function (data) {
          while (interactables.children.length > 0) {
            interactables.remove(interactables.children[0]);
          }
          console.log("reset")
        })

        socket.on('userList', function (data) {
          userList = data
          createCharacters()
        })
      });

      var scene, camera, renderer, clock, deltaTime, totalTime;

      var arToolkitSource, arToolkitContext;

      var environment, interactables, characters;

      var raycastObjects = []

      // var AF, BF, CF, DF, EF, FF, AB, BB, CB, DB, EB, FB;
      // var HotdogBuilding, DonutBuilding, IceCreamBuilding, ShortBuilding, TallBuilding;
      let Player = {}
      let joystick, isJoystickUsed

      let modal = false;
      let brush = 1;
      let sizeTemp
      let size='50'
      let motifTemp;
      let motif=1;
      let landTemp = 'A'

      let playerList = {
        "Bimo Arsa": {
        }
      }

      let model, colour;
      let raycaster = new THREE.Raycaster();
      let mouse = new THREE.Vector2();

      initialize();
      animate();


      // Create JoyStick object into the DIV 'joyDiv'
      var joy = new JoyStick('joyDiv');

      let turn, forward, radius, rotation
      function joystickStart() {
        isJoystickUsed = true
      }

      function joystickStop() {
        isJoystickUsed = false
        Player.forward = 0
      }

      function updateRemotePlayer() {
        if (remoteData) {
          remoteData.forEach(data => {
            let characterTemp = characterList.find(x => x.id === data.id)
            if (characterTemp) {

              characterTemp.object.position.set(data.x, data.y, data.z);
              const euler = new THREE.Euler(data.pb, data.heading, data.pb);
              characterTemp.object.quaternion.setFromEuler(euler);
            }
          })
        }
      }

      function movePlayer(dt) {
        if (Player.forward > 0.3) {
          Player.object.translateZ(dt * 0.6);
        }

        if (isJoystickUsed) {
          if (Player.object.position.x > 2.5/ 2) {
            Player.object.position.x = 2.5 / 2
          }
          if (Player.object.position.x < -2.5 / 2) {
            Player.object.position.x = -2.5 / 2
          }
          if (Player.object.position.z > 2.5 / 2) {
            Player.object.position.z = 2.5 / 2
          }
          if (Player.object.position.z < -2.5 / 2) {
            Player.object.position.z = -2.5 / 2
          }
        }

        updateSocket()
      }

      function createCharacters() {
        if (userList) {
          while (characters.children.length > 0) {
            characters.remove(characters.children[0]);
          }
          characterList = []

          let floader = new THREE.FBXLoader();
          let loader = new THREE.TextureLoader();
          userList.forEach((user) => {
            if (user.id != id) {

              floader.load(`assets/fbx/people/${user.model}.fbx`, function (object) {
                object.scale.multiplyScalar(0.001)

                object.name = user.name;

                object.traverse(function (child) {
                  if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = false;
                  }
                });

                loader.load(`assets/images/SimplePeople_${user.model}_${user.colour}.png`, function (texture) {
                  object.traverse(function (child) {
                    if (child.isMesh) {
                      child.material.map = texture;
                    }
                  });
                });
                characters.add(object);
                characterList.push({ id: user.id, object: object })
              });
            }
          })
        }
      }

      function initialize() {
        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(45, 2, 0.1, 100);
        // camera.rotation.y=Math.PI/2
        scene.add(camera);

        renderer = new THREE.WebGLRenderer({
          antialias: true,
          alpha: true
        });
        renderer.setClearColor(new THREE.Color('lightgrey'), 0)

        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.domElement.style.position = 'absolute'
        renderer.domElement.style.top = '0px'
        renderer.domElement.style.left = '0px'
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();
        deltaTime = 0;
        totalTime = 0;

        ////////////////////////////////////////////////////////////
        // setup arToolkitSource
        ////////////////////////////////////////////////////////////

        arToolkitSource = new THREEx.ArToolkitSource({
          sourceType: 'webcam',
        });

        function onResize() {
          arToolkitSource.onResizeElement()
          arToolkitSource.copyElementSizeTo(renderer.domElement)
          if (arToolkitContext.arController !== null) {
            arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
          }
        }

        arToolkitSource.init(function onReady() {
          onResize()
        });

        // handle resize event
        window.addEventListener('resize', function () {
          onResize()
        });

        ////////////////////////////////////////////////////////////
        // setup arToolkitContext
        ////////////////////////////////////////////////////////////	

        // create atToolkitContext
        arToolkitContext = new THREEx.ArToolkitContext({
          cameraParametersUrl: 'data/camera_para.dat',
          detectionMode: 'mono'
        });

        // copy projection matrix to camera when initialization complete
        arToolkitContext.init(function onCompleted() {
          camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
        });

        ////////////////////////////////////////////////////////////
        // setup markerRoots
        ////////////////////////////////////////////////////////////

        // build markerControls
        environment = new THREE.Group();
        scene.add(environment);
        interactables = new THREE.Group();
        scene.add(interactables);
        let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, environment, {
          type: 'pattern', patternUrl: "data/marker.patt"
        })


        let markerControls2 = new THREEx.ArMarkerControls(arToolkitContext, environment, {
          type: 'pattern', patternUrl: "data/kanji.patt"
        })
        ////////////////////////////////////////////////////////////
        // setup scene
        ////////////////////////////////////////////////////////////

        // joystick = new JoyStick({
        //   onMove: playerControl
        // });

        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        interactables = new THREE.Group();
        environment.add(interactables);
        characters = new THREE.Group();
        environment.add(characters);

        let floader = new THREE.FBXLoader();
        let loader = new THREE.TextureLoader();

        const people = ['BeachBabe', 'BusinessMan', 'Doctor', 'FireFighter', 'Housewife', 'Policeman', 'Prostitute', 'Punk', 'RiotCop', 'Roadworker', 'Robber', 'Sheriff', 'Streetman', 'Waitress'];
        model = people[Math.floor(Math.random() * people.length)];

        floader.load(`assets/fbx/people/${model}.fbx`, function (object) {
          object.scale.multiplyScalar(0.001)

          object.name = id;

          object.traverse(function (child) {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = false;
            }
          });

          const name = model;//object.children[game.player.index].name.substring(3);
          const colours = ['Black', 'Brown', 'White'];
          colour = colours[Math.floor(Math.random() * colours.length)];

          loader.load(`assets/images/SimplePeople_${name}_${colour}.png`, function (texture) {
            object.traverse(function (child) {
              if (child.isMesh) {
                child.material.map = texture;
              }
            });
          });

          environment.add(object);
          Player.object = object;
          Player.object.position.y=.3
        });


        const geometry = new THREE.CircleGeometry( 2, 64 ); 
        const material = new THREE.MeshBasicMaterial( { color: 0xffffff } ); 

        floorMesh = new THREE.Mesh(geometry, material );
        floorMesh.rotation.x = -Math.PI / 2;
        // floorMesh.receiveShadow = true;
        environment.add(floorMesh);


        let light = new THREE.PointLight(0xffffff, 1, 50);
        light.position.set(8, 8, 0); // default; light shining from top
        light.castShadow = true;
        environment.add(light);

        let ambientLight = new THREE.AmbientLight(0x666666);
        environment.add(ambientLight);
        // let helper = new THREE.CameraHelper( camera );
        // environment.add( helper );
      }

      function onMouseMove(event) {
        // calculate mouse position in normalized device coordinates
        // (-1 to +1) for both components

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
      }


      function initSocket() {
        //console.log("PlayerLocal.initSocket");
        if (Player.object) {
          socket.emit('init', {
            username: username,
            model: model,
            colour: colour,
            x: Player.object.position.x,
            y: Player.object.position.y,
            z: Player.object.position.z,
            h: Player.object.rotation.y,
            pb: Player.object.rotation.x,
          });
        }
      }

      function updateSocket() {
        if (socket !== undefined && Player.object) {
          //console.log(`PlayerLocal.updateSocket - rotation(${this.object.rotation.x.toFixed(1)},${this.object.rotation.y.toFixed(1)},${this.object.rotation.z.toFixed(1)})`);
          socket.emit('update', {
            x: Player.object.position.x,
            y: Player.object.position.y,
            z: Player.object.position.z,
            h: Player.object.rotation.y,
            pb: Player.object.rotation.x,
          })
          // console.log(Player.object.children)
        }
      }

      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener("touchstart", function funcref(evt) {
        window.removeEventListener("touchstart", funcref, false);
      }, false);

      function update() {
        // update artoolkit on every frame
        if (arToolkitSource.ready !== false)
          arToolkitContext.update(arToolkitSource.domElement);

        if (isJoystickUsed) {
          turn = joy.GetPosY() / 50 * (joy.GetPosX() - 50) / 25;
          forward = joy.GetPosX() / 50 * (50 - joy.GetPosY()) / 25;

          if (turn > 1) {
            turn = 1
          }
          if (turn < -1) {
            turn = -1
          }
          if (forward > 1) {
            forward = 1
          }
          if (forward < -1) {
            forward = -1
          }
          radius = Math.sqrt(Math.pow(forward, 2) + Math.pow(turn, 2));
          Player.forward = radius

          rotation = forward >= 0 && turn >= 0 ? turn * Math.PI / 2 : forward < 0 && turn >= 0 ? Math.PI - turn * Math.PI / 2 : forward < 0 && turn < 0 ? Math.PI - turn * Math.PI / 2 : forward >= 0 && turn < 0 ? Math.PI * 2 + turn * Math.PI / 2 : rotation
          rotation = -rotation + Math.PI

          Player.object.rotation.y = rotation

          raycastObjects = []
        }
      }

      function render() {
        renderer.render(scene, camera);
      }

      const cloneFbx = (fbx) => {
        const clone = fbx.clone(true)
        clone.animations = fbx.animations
        clone.skeleton = { bones: [] }

        const skinnedMeshes = {}

        fbx.traverse(node => {
          if (node.isSkinnedMesh) {
            skinnedMeshes[node.name] = node
          }
        })

        const cloneBones = {}
        const cloneSkinnedMeshes = {}

        clone.traverse(node => {
          if (node.isBone) {
            cloneBones[node.name] = node
          }

          if (node.isSkinnedMesh) {
            cloneSkinnedMeshes[node.name] = node
          }
        })

        for (let name in skinnedMeshes) {
          const skinnedMesh = skinnedMeshes[name]
          const skeleton = skinnedMesh.skeleton
          const cloneSkinnedMesh = cloneSkinnedMeshes[name]

          const orderedCloneBones = []

          for (let i = 0; i < skeleton.bones.length; i++) {
            const cloneBone = cloneBones[skeleton.bones[i].name]
            orderedCloneBones.push(cloneBone)
          }

          cloneSkinnedMesh.bind(
            new THREE.Skeleton(orderedCloneBones, skeleton.boneInverses),
            cloneSkinnedMesh.matrixWorld)

          // For animation to work correctly:
          clone.skeleton.bones.push(cloneSkinnedMesh)
          clone.skeleton.bones.push(...orderedCloneBones)
        }

        return clone
      }


      function resetButton() {
        $('button#1').css({ "background":"transparent" })
        $('button#2').css({ "background":"transparent" })
        $('button#3').css({ "background":"transparent" })
        $('button#4').css({ "background":"transparent" })
        $('button#5').css({ "background":"transparent" })
        $('button#6').css({ "background":"transparent" })
        $('button#7').css({ "background":"transparent" })
        $('button#8').css({ "background":"transparent" })
        $('button#9').css({ "background":"transparent" })
        $('button#10').css({ "background":"transparent" })
        $('button#11').css({ "background":"transparent" })
      }

      

      //HTML Side
      function selectButton(motif) {
        resetButton()

        if (motif == 1) {
          $('button#1').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 1;
        }
        if (motif == 2) {
          $('button#2').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 2;
        }
        if (motif == 3) {
          $('button#3').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 3;
        }
        if (motif == 4) {
          $('button#4').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 4;
        }
        if (motif == 5) {
          $('button#5').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 5;
        }
        if (motif == 6) {
          $('button#6').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 6;
        }
        if (motif == 7) {
          $('button#7').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 7;
        }
        if (motif == 8) {
          $('button#8').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 8;
        }
        if (motif == 9) {
          $('button#9').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 9;
        }
        if (motif == 10) {
          $('button#10').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 10;
        }
        if (motif == 11) {
          $('button#11').css({ "background":"rgb(0,0,0,0.1)" })
          motifTemp = 11;
        }
        
        $("#motifPreview").attr('src',  `assets/brush/Beads-${motif}.png`);
      }
      var startTime;

      function actionAdd() {        
        if (socket !== undefined && Player.object) {
          socket.emit('actionAdd', { username:username, motif:motif, size:size, x:Player.object.position.x, z:Player.object.position.z, timeStamp:Date.now() })
          modal = false
          motifTemp = null
          // console.log("add client",{ motif:motif, size:size, x:Player.object.position.x, z:Player.object.position.z, timeStamp:Date.now() })
        }
      }


      // function actionBuild() {
      //   resetButton()
      //   startTime = Date.now()
      //   socket.emit('actionBuild', { land: landTemp, data: { vacant: false, building: motifTemp, owner: username } })
      //   modal = false
      //   motifTemp = null
      // }

      socket.on('pong', function () {
        latency = Date.now() - startTime;
        console.log(latency);
      });

      // function actionDestroy() {
      //   resetButton()

      //   socket.emit('actionDestroy', { land: landTemp, data: { vacant: true, building: null, owner: "" } })
      //   buildingState[landTemp] = { vacant: true, building: null, owner: "" }
      //   modal = false
      //   motifTemp = null
      // }

      function openModal() {
        selectButton(motif)
        sizeTemp=size
        motifTemp = motif
        $("#sizeSlider").val(size)
        $("#motifPreview").css({"height":20+25*sizeTemp/100+"%","width":"100%"});
        modal = true
      }

      function closeModal() {
        modal = false
        motifTemp = null
      }

      function saveModal() {
        size=sizeTemp
        motif=motifTemp
        motifTemp = null
        $("#selectedMotif").attr('src',  `assets/brush/Beads-${motif}.png`);
        modal = false
      }

      function loadHTML(size) {
        $(function () {
          $("#modal").toggle(modal)
          const input = document.querySelector("#pi_input");
        })
        $(document).on('input', '#sizeSlider', function() {
            sizeTemp = $(this).val();
            $("#motifPreview").css({"height":20+25*sizeTemp/100+"%","width":"100%"});
        });
      }

      function loadCanvas() {
        console.log(brushes)
       brushes.map((item,index)=>{
        
        let loader = new THREE.TextureLoader();
      
        const plane = new THREE.PlaneGeometry( 2*(parseInt(item.size)/100), 2*(parseInt(item.size)/100) ); 
        const image = new THREE.MeshBasicMaterial( {map: loader.load(`assets/brush/Beads-${item.motif}.png`), transparent: true,blending: THREE.NormalBlending, depthTest: true, depthWrite: false,} ); 

        floorMesh = new THREE.Mesh(plane, image );
        floorMesh.rotation.x = -Math.PI / 2;
        floorMesh.position.x = item.x
        floorMesh.position.y = item.motif>6?.1+(index+1)*.01:.2+(index+1)*.015
        floorMesh.position.z = item.z
        floorMesh.renderOrder=item.motif>6?index:100+index
        // floorMesh.receiveShadow = true;
        interactables.add(floorMesh);
        console.log(index, parseFloat(`.1${index}`),floorMesh.position.x, floorMesh.position.z,floorMesh.position.y)
       })
      }

      function animate() {
      

        deltaTime = clock.getDelta();
        totalTime += deltaTime;

        requestAnimationFrame(animate);

        loadHTML()
        // if (!isMobile()) {
        //   resetMaterials();
        //   hover();
        // }
        update();

        //navigation
        updateRemotePlayer(deltaTime)
        movePlayer(deltaTime)
        render();
      }
    </script>
    
  <!-- <script>
    
        function isMobile() {
          let check = false;
          (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
          return check;
        };

    function hover() {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(raycastObjects, true);
      if (intersects[0]) {
        if (intersects[0].object.name == "AF" || intersects[0].object.name == "BF" || intersects[0].object.name == "CF") {
          intersects[0].object.material.transparent = true
          intersects[0].object.material.opacity = 0.5;
        }
        if (intersects[0].object.name == "Building") {
          intersects[0].object.material.forEach(function (child) {
            child.transparent = true
            child.opacity = 0.5;
          });
        }
      }
    }

    function resetMaterials() {
      for (let i = 0; i < raycastObjects.length; i++) {
        if (raycastObjects[i].material && (raycastObjects[i].name == "AF" || raycastObjects[i].name == "BF" || raycastObjects[i].name == "CF")) {
          raycastObjects[i].material.opacity = 1;
        }
        if (raycastObjects[i] && raycastObjects[i].name == "Building") {
          raycastObjects[i].children.forEach(function (child) {
            // console.log(child.name)
            child.material.forEach(function (material) {
              material.opacity = 1;
            });
          })
        }
      }
    }
  </script> -->

</body>

</html>